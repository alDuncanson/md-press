name: Test Action

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  test-single-file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test markdown
        run: |
          cat > test.md << 'EOF'
          ---
          geometry: margin=0.75in
          header-includes: |
            \pagenumbering{gobble}
          ---

          # Test Document

          This is a test document generated from branch `${{ github.head_ref }}` on PR #${{ github.event.pull_request.number }}.

          ## Features Being Tested

          - PDF generation with pandoc + tectonic
          - HTML generation with OpenGraph meta tags
          - Preview image generation

          ## Sample Content

          Here's some **bold text**, *italic text*, and `inline code`.

          > A blockquote to test formatting.

          - Bullet point one
          - Bullet point two
          - Bullet point three
          EOF

      - uses: ./
        id: test
        with:
          source: test.md
          deploy: 'false'

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-output-single
          path: _site/

  test-combined:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test markdown files
        run: |
          mkdir -p docs/guides

          cat > docs/01-index.md << 'EOF'
          # Documentation Home

          Welcome to the docs. See [Getting Started](guides/01-getting-started.md) or [Advanced Usage](guides/02-advanced.md).
          EOF

          cat > docs/guides/01-getting-started.md << 'EOF'
          # Getting Started

          This guide covers the basics. For more, see [Advanced Usage](02-advanced.md) or return to the [Home](../01-index.md).

          ## Installation

          1. Step one
          2. Step two
          3. Step three
          EOF

          cat > docs/guides/02-advanced.md << 'EOF'
          # Advanced Usage

          Building on the [Getting Started](01-getting-started.md) guide.

          ## Configuration

          Configure options as needed.

          ## Tips

          - Tip one
          - Tip two
          EOF

      - uses: ./
        id: test-multi
        with:
          sources: 'docs/**/*.md'
          output-pdf: docs.pdf
          mode: 'combined'
          index-title: 'Documentation'
          deploy: 'false'

      - name: Verify multi-file combined output
        run: |
          echo "Checking generated files..."
          ls -la _site/
          ls -la _site/docs/ || true
          ls -la _site/docs/guides/ || true

          # Verify index was generated with custom title
          test -f _site/index.html || (echo "Missing index.html" && exit 1)
          grep -q 'Documentation' _site/index.html || (echo "Missing custom index title" && exit 1)

          # Verify HTML files preserve directory structure
          test -f _site/docs/01-index.html || (echo "Missing docs/01-index.html" && exit 1)
          test -f _site/docs/guides/01-getting-started.html || (echo "Missing 01-getting-started.html" && exit 1)
          test -f _site/docs/guides/02-advanced.html || (echo "Missing 02-advanced.html" && exit 1)

          # Verify combined PDF
          test -f _site/docs.pdf || (echo "Missing docs.pdf" && exit 1)

          # Verify single preview image for combined PDF
          test -f _site/preview.png || (echo "Missing preview.png" && exit 1)

          # Verify .md links were rewritten to .html
          if grep -q '\.md"' _site/docs/index.html; then
            echo "ERROR: Found .md links in HTML output"
            exit 1
          fi

          # Verify md-press link in index
          grep -q 'md-press' _site/index.html || (echo "Missing md-press attribution link" && exit 1)

          echo "All combined mode checks passed!"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-output-combined
          path: _site/

  test-collection-flat:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create flat collection of unrelated documents
        run: |
          mkdir -p job-docs

          cat > job-docs/resume.md << 'EOF'
          # John Doe - Resume

          ## Experience
          - Software Engineer at Acme Corp
          - Junior Developer at StartupXYZ

          ## Education
          - BS Computer Science
          EOF

          cat > job-docs/cover-letter.md << 'EOF'
          # Cover Letter

          Dear Hiring Manager,

          I am writing to express my interest...

          Sincerely,
          John Doe
          EOF

          cat > job-docs/references.md << 'EOF'
          # Professional References

          1. Jane Smith - Manager at Acme Corp
          2. Bob Johnson - CTO at StartupXYZ
          EOF

      - uses: ./
        with:
          sources: 'job-docs/*.md'
          mode: 'collection'
          index-title: 'My Documents'
          deploy: 'false'

      - name: Verify collection flat output
        run: |
          echo "Checking generated files..."
          ls -la _site/
          ls -la _site/job-docs/

          # Verify index page
          test -f _site/index.html || (echo "Missing index.html" && exit 1)
          grep -q 'My Documents' _site/index.html || (echo "Missing custom index title" && exit 1)

          # Verify individual HTML files
          test -f _site/job-docs/resume.html || (echo "Missing resume.html" && exit 1)
          test -f _site/job-docs/cover-letter.html || (echo "Missing cover-letter.html" && exit 1)
          test -f _site/job-docs/references.html || (echo "Missing references.html" && exit 1)

          # Verify individual PDFs
          test -f _site/job-docs/resume.pdf || (echo "Missing resume.pdf" && exit 1)
          test -f _site/job-docs/cover-letter.pdf || (echo "Missing cover-letter.pdf" && exit 1)
          test -f _site/job-docs/references.pdf || (echo "Missing references.pdf" && exit 1)

          # Verify individual preview images
          test -f _site/job-docs/resume.png || (echo "Missing resume.png" && exit 1)
          test -f _site/job-docs/cover-letter.png || (echo "Missing cover-letter.png" && exit 1)
          test -f _site/job-docs/references.png || (echo "Missing references.png" && exit 1)

          # Verify index links to PDFs
          grep -q 'resume.pdf' _site/index.html || (echo "Missing PDF link in index" && exit 1)

          echo "All collection flat mode checks passed!"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-output-collection-flat
          path: _site/

  test-collection-nested:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create nested collection of documents
        run: |
          mkdir -p projects/web projects/mobile

          cat > projects/web/portfolio.md << 'EOF'
          # Web Portfolio

          ## Projects
          - E-commerce site
          - Blog platform
          EOF

          cat > projects/web/case-study.md << 'EOF'
          # Case Study: E-commerce Redesign

          ## Challenge
          The client needed a modern redesign...

          ## Solution
          We implemented a new design system...
          EOF

          cat > projects/mobile/app-showcase.md << 'EOF'
          # Mobile App Showcase

          ## iOS Apps
          - Fitness Tracker
          - Recipe Manager
          EOF

      - uses: ./
        with:
          sources: 'projects/**/*.md'
          mode: 'collection'
          index-title: 'Project Portfolio'
          deploy: 'false'

      - name: Verify collection nested output
        run: |
          echo "Checking generated files..."
          ls -la _site/
          ls -la _site/projects/web/ || true
          ls -la _site/projects/mobile/ || true

          # Verify index page
          test -f _site/index.html || (echo "Missing index.html" && exit 1)
          grep -q 'Project Portfolio' _site/index.html || (echo "Missing custom index title" && exit 1)

          # Verify nested HTML files
          test -f _site/projects/web/portfolio.html || (echo "Missing portfolio.html" && exit 1)
          test -f _site/projects/web/case-study.html || (echo "Missing case-study.html" && exit 1)
          test -f _site/projects/mobile/app-showcase.html || (echo "Missing app-showcase.html" && exit 1)

          # Verify nested PDFs
          test -f _site/projects/web/portfolio.pdf || (echo "Missing portfolio.pdf" && exit 1)
          test -f _site/projects/web/case-study.pdf || (echo "Missing case-study.pdf" && exit 1)
          test -f _site/projects/mobile/app-showcase.pdf || (echo "Missing app-showcase.pdf" && exit 1)

          # Verify nested preview images
          test -f _site/projects/web/portfolio.png || (echo "Missing portfolio.png" && exit 1)
          test -f _site/projects/web/case-study.png || (echo "Missing case-study.png" && exit 1)
          test -f _site/projects/mobile/app-showcase.png || (echo "Missing app-showcase.png" && exit 1)

          echo "All collection nested mode checks passed!"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-output-collection-nested
          path: _site/

  comment-on-pr:
    needs: [test-single-file, test-combined, test-collection-flat, test-collection-nested]
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR with preview
        uses: actions/github-script@v7
        with:
          script: |
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            let body = `## Test Build Preview\n\n`;
            body += `Generated from \`${context.payload.pull_request.head.sha.substring(0, 7)}\`\n\n`;
            body += `### Artifacts\n\n`;
            body += `Download the generated files from the [workflow run](${artifactUrl}):\n\n`;
            body += `**Single-file mode (test-output-single):**\n`;
            body += `- resume.pdf\n`;
            body += `- index.html\n`;
            body += `- preview.png\n\n`;
            body += `**Combined mode (test-output-combined):**\n`;
            body += `- docs.pdf (combined)\n`;
            body += `- index.html (auto-generated index)\n`;
            body += `- docs/*.html (individual pages)\n`;
            body += `- preview.png\n\n`;
            body += `**Collection mode - flat (test-output-collection-flat):**\n`;
            body += `- resume.pdf, cover-letter.pdf, references.pdf\n`;
            body += `- resume.html, cover-letter.html, references.html\n`;
            body += `- *-preview.png (one per document)\n\n`;
            body += `**Collection mode - nested (test-output-collection-nested):**\n`;
            body += `- projects/web/*.pdf, projects/mobile/*.pdf\n`;
            body += `- projects/web/*.html, projects/mobile/*.html\n`;
            body += `- *-preview.png (one per document)\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
